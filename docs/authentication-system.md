# Lumina AI Studio è®¤è¯ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

> **ç‰ˆæœ¬**: 1.0.0
> **æ—¥æœŸ**: 2025å¹´12æœˆ
> **åŸºäº**: Next.js 16 + Drizzle ORM + PostgreSQL

## ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [å®‰å…¨æœ€ä½³å®è·µ (2025)](#å®‰å…¨æœ€ä½³å®è·µ-2025)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [API è·¯ç”±](#api-è·¯ç”±)
6. [ç”¨æˆ·ä½“éªŒè®¾è®¡](#ç”¨æˆ·ä½“éªŒè®¾è®¡)
7. [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)

---

## ç³»ç»Ÿæ¦‚è¿°

### åŠŸèƒ½ç‰¹æ€§

âœ… **å·²å®ç°**ï¼š
- ç”¨æˆ·å/å¯†ç ç™»å½•æ³¨å†Œ
- GitHub OAuth ç™»å½•
- ç»Ÿä¸€ç™»å½•æ³¨å†Œå…¥å£ï¼ˆæ™ºèƒ½è¯†åˆ«ï¼‰
- JWT ä¼šè¯ç®¡ç†
- åˆå§‹ç§¯åˆ†é…ç½®
- Data Access Layer å®‰å…¨æ¨¡å¼

ğŸš§ **å·²è®¾è®¡ï¼ˆæœªå®ç°ï¼‰**ï¼š
- é‚®ç®±éªŒè¯ç ç™»å½•
- çŸ­ä¿¡éªŒè¯ç ç™»å½•
- Google OAuth ç™»å½•
- è®¤è¯æ–¹å¼ç¦ç”¨æœºåˆ¶

### æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Next.js | 16.0.5 | åº”ç”¨æ¡†æ¶ |
| React | 19.2.0 | UI æ¡†æ¶ |
| Drizzle ORM | 0.44.7 | æ•°æ®åº“ ORM |
| PostgreSQL | - | æ•°æ®åº“ |
| Jose | 6.1.2 | JWT å¤„ç† |
| bcryptjs | 3.0.3 | å¯†ç åŠ å¯† |
| Zod | 4.1.13 | æ•°æ®éªŒè¯ |

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·ç•Œé¢                              â”‚
â”‚                    /login (ç»Ÿä¸€å…¥å£)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         API å±‚                                â”‚
â”‚  /api/auth/check         - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨                   â”‚
â”‚  /api/auth/authenticate  - ç»Ÿä¸€è®¤è¯æ¥å£                       â”‚
â”‚  /api/auth/github        - GitHub OAuth                      â”‚
â”‚  /api/auth/logout        - ç™»å‡º                              â”‚
â”‚  /api/auth/me            - è·å–å½“å‰ç”¨æˆ·                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æœåŠ¡å±‚ (Service Layer)                   â”‚
â”‚  lib/auth/service.ts - ä¸šåŠ¡é€»è¾‘                               â”‚
â”‚    - registerUser()         - æ³¨å†Œç”¨æˆ·                       â”‚
â”‚    - loginWithPassword()    - å¯†ç ç™»å½•                       â”‚
â”‚    - findOrCreateGithubUser() - GitHub ç™»å½•                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®è®¿é—®å±‚ (Data Access Layer)                   â”‚
â”‚  lib/auth/dal.ts - è®¤è¯éªŒè¯ (2025 å®‰å…¨æ¨¡å¼)                   â”‚
â”‚    - verifySession()    - éªŒè¯ä¼šè¯                           â”‚
â”‚    - getCurrentUserId() - è·å–å½“å‰ç”¨æˆ· ID                     â”‚
â”‚    - isAuthenticated()  - æ£€æŸ¥æ˜¯å¦è®¤è¯                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ä¼šè¯ç®¡ç† (Session Management)                 â”‚
â”‚  lib/auth/session.ts - JWT ä¼šè¯å¤„ç†                           â”‚
â”‚    - createSession()  - åˆ›å»ºä¼šè¯                             â”‚
â”‚    - getSession()     - è·å–ä¼šè¯                             â”‚
â”‚    - deleteSession()  - åˆ é™¤ä¼šè¯                             â”‚
â”‚    - updateSession()  - æ›´æ–°ä¼šè¯                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®åº“ (PostgreSQL)                        â”‚
â”‚  - users                - ç”¨æˆ·è¡¨                             â”‚
â”‚  - user_identities      - ç”¨æˆ·èº«ä»½è¡¨                         â”‚
â”‚  - accounts             - è´¦æˆ·è¡¨                             â”‚
â”‚  - verification_codes   - éªŒè¯ç è¡¨ (æœªä½¿ç”¨)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¤è¯æµç¨‹

#### å¯†ç ç™»å½•/æ³¨å†Œæµç¨‹

```
ç”¨æˆ·è¾“å…¥ç”¨æˆ·å/é‚®ç®±
      â”‚
      â–¼
è°ƒç”¨ /api/auth/check
      â”‚
      â”œâ”€â†’ ç”¨æˆ·å­˜åœ¨ â†’ æ˜¾ç¤ºå¯†ç è¾“å…¥æ¡† (ç™»å½•æ¨¡å¼)
      â”‚                  â”‚
      â”‚                  â–¼
      â”‚            è°ƒç”¨ /api/auth/authenticate (login)
      â”‚                  â”‚
      â”‚                  â–¼
      â”‚            éªŒè¯å¯†ç  â†’ åˆ›å»ºä¼šè¯ â†’ è·³è½¬é¦–é¡µ
      â”‚
      â””â”€â†’ ç”¨æˆ·ä¸å­˜åœ¨ â†’ æ˜¾ç¤ºæ³¨å†Œè¡¨å• (æ³¨å†Œæ¨¡å¼)
                         â”‚
                         â–¼
                   è°ƒç”¨ /api/auth/authenticate (register)
                         â”‚
                         â–¼
                   åˆ›å»ºç”¨æˆ· â†’ åˆ›å»ºè´¦æˆ· â†’ åˆ›å»ºä¼šè¯ â†’ è·³è½¬é¦–é¡µ
```

#### GitHub OAuth æµç¨‹

```
ç‚¹å‡» "Github" æŒ‰é’®
      â”‚
      â–¼
è·³è½¬åˆ° /api/auth/github
      â”‚
      â–¼
ç”Ÿæˆ state + è·³è½¬åˆ° GitHub æˆæƒé¡µé¢
      â”‚
      â–¼
ç”¨æˆ·æˆæƒ â†’ GitHub å›è°ƒ /api/auth/github/callback
      â”‚
      â”œâ”€â†’ éªŒè¯ state (CSRF ä¿æŠ¤)
      â”‚
      â”œâ”€â†’ ç”¨ code æ¢å– access_token
      â”‚
      â”œâ”€â†’ è·å– GitHub ç”¨æˆ·ä¿¡æ¯
      â”‚
      â”œâ”€â†’ æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
      â”‚
      â””â”€â†’ åˆ›å»ºä¼šè¯ â†’ è·³è½¬é¦–é¡µ
```

---

## å®‰å…¨æœ€ä½³å®è·µ (2025)

### é‡è¦å®‰å…¨æ›´æ–°

âš ï¸ **CVE-2025-29927** - Next.js Proxy æ¼æ´
- **å½±å“**: Proxy (middleware) ä¸å†è¢«è®¤ä¸ºæ˜¯å®‰å…¨çš„å”¯ä¸€é˜²çº¿
- **è§£å†³æ–¹æ¡ˆ**: å®ç° Data Access Layer æ¨¡å¼

### å¤šå±‚å®‰å…¨é˜²æŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬1å±‚: Proxy (proxy.ts)                                 â”‚
â”‚  - åˆæ­¥æ£€æŸ¥ä¼šè¯                                           â”‚
â”‚  - é‡å®šå‘æœªè®¤è¯ç”¨æˆ·åˆ°ç™»å½•é¡µ                               â”‚
â”‚  - åˆ·æ–°ä¼šè¯ï¼ˆå»¶é•¿ç™»å½•æ—¶é—´ï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬2å±‚: API Route Handler                                â”‚
â”‚  - å¤„ç†è¯·æ±‚                                               â”‚
â”‚  - åŸºæœ¬è¾“å…¥éªŒè¯ï¼ˆZod schemaï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬3å±‚: Data Access Layer â­ æ ¸å¿ƒå®‰å…¨å±‚                   â”‚
â”‚  - verifySession() éªŒè¯ä¼šè¯                               â”‚
â”‚  - æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸ                                       â”‚
â”‚  - è¿”å›ç”¨æˆ·ä¿¡æ¯æˆ–æŠ›å‡ºå¼‚å¸¸                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### JWT ä¼šè¯å®‰å…¨

- **ç®—æ³•**: HS256 (HMAC with SHA-256)
- **ç­¾åå¯†é’¥**: `AUTH_SECRET` ç¯å¢ƒå˜é‡ï¼ˆæœ€å°‘ 32 å­—ç¬¦ï¼‰
- **ä¼šè¯æ—¶é•¿**: 7 å¤©
- **å­˜å‚¨æ–¹å¼**: HTTP-only Cookie
- **Cookie é…ç½®**:
  ```typescript
  {
    httpOnly: true,           // é˜²æ­¢ XSS
    secure: production,       // ç”Ÿäº§ç¯å¢ƒä»… HTTPS
    sameSite: 'lax',          // é˜²æ­¢ CSRF
    expires: 7days,           // è‡ªåŠ¨è¿‡æœŸ
    path: '/'                 // å…¨ç«™å¯ç”¨
  }
  ```

### å¯†ç å®‰å…¨

- **åŠ å¯†ç®—æ³•**: bcrypt
- **Salt Rounds**: 10
- **å¯†ç è¦æ±‚**:
  - æœ€å°‘ 8 å­—ç¬¦
  - è‡³å°‘1ä¸ªå¤§å†™å­—æ¯
  - è‡³å°‘1ä¸ªå°å†™å­—æ¯
  - è‡³å°‘1ä¸ªæ•°å­—

### OAuth å®‰å…¨

- **CSRF ä¿æŠ¤**: ä½¿ç”¨ `state` å‚æ•°
- **Token å­˜å‚¨**: å­˜å‚¨åœ¨æ•°æ®åº“ `metadata.oauth.accessToken`
- **æƒé™èŒƒå›´**: æœ€å°æƒé™åŸåˆ™ (`read:user`, `user:email`)

---

## æ•°æ®åº“è®¾è®¡

### ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      users           â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id (PK)             â”‚
â”‚  username (UNIQUE)   â”‚
â”‚  email (UNIQUE)      â”‚
â”‚  avatar              â”‚
â”‚  created_at          â”‚
â”‚  updated_at          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1
           â”‚
           â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  user_identities     â”‚        â”‚    accounts         â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id (PK)             â”‚   1:1  â”‚  id (PK)            â”‚
â”‚  user_id (FK)        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”¤  user_id (FK,UNIQ)  â”‚
â”‚  provider (ENUM)     â”‚        â”‚  balance (BIGINT)   â”‚
â”‚  provider_user_id    â”‚        â”‚  created_at         â”‚
â”‚  metadata (JSONB)    â”‚        â”‚  updated_at         â”‚
â”‚  is_primary          â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  created_at          â”‚
â”‚  updated_at          â”‚
â”‚  UNIQUE(provider,    â”‚
â”‚    provider_user_id) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  verification_codes      â”‚  (é¢„ç•™ï¼Œæœªä½¿ç”¨)
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  id (PK)                 â”‚
â”‚  recipient               â”‚
â”‚  channel (ENUM)          â”‚
â”‚  code_hash               â”‚
â”‚  purpose                 â”‚
â”‚  expires_at              â”‚
â”‚  used                    â”‚
â”‚  attempts                â”‚
â”‚  max_attempts            â”‚
â”‚  user_id (FK, NULLABLE)  â”‚
â”‚  created_at              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡¨è¯¦ç»†è®¾è®¡

#### users è¡¨

ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨ã€‚

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | serial | PRIMARY KEY | ç”¨æˆ·ID |
| username | varchar(64) | NOT NULL, UNIQUE | ç”¨æˆ·å |
| email | varchar(255) | UNIQUE | é‚®ç®±ï¼ˆå¯é€‰ï¼‰ |
| avatar | text | DEFAULT '' | å¤´åƒ URL |
| created_at | timestamptz | NOT NULL | åˆ›å»ºæ—¶é—´ |
| updated_at | timestamptz | NOT NULL | æ›´æ–°æ—¶é—´ |

#### user_identities è¡¨

ç”¨æˆ·èº«ä»½è®¤è¯æ–¹å¼è¡¨ï¼ˆæ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼‰ã€‚

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | serial | PRIMARY KEY | èº«ä»½ID |
| user_id | integer | NOT NULL, FK â†’ users.id | æ‰€å±ç”¨æˆ· |
| provider | auth_provider | NOT NULL | è®¤è¯æä¾›å•† |
| provider_user_id | varchar(128) | NOT NULL | æä¾›å•†çš„ç”¨æˆ·ID |
| metadata | jsonb | NOT NULL | è®¤è¯å…ƒæ•°æ® |
| is_primary | boolean | DEFAULT false | æ˜¯å¦ä¸ºä¸»è¦è®¤è¯æ–¹å¼ |
| created_at | timestamptz | NOT NULL | åˆ›å»ºæ—¶é—´ |
| updated_at | timestamptz | NOT NULL | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**:
- UNIQUE(provider, provider_user_id) - é˜²æ­¢é‡å¤ç»‘å®š
- INDEX(user_id, provider) - æŸ¥è¯¢ä¼˜åŒ–

**metadata ç»“æ„**:
```typescript
{
  // å¯†ç è®¤è¯
  password?: {
    passwordHash: string      // bcrypt å“ˆå¸Œ
    needReset?: boolean       // æ˜¯å¦éœ€è¦é‡ç½®å¯†ç 
  }

  // OAuth è®¤è¯
  oauth?: {
    accessToken?: string      // OAuth access token
    refreshToken?: string     // OAuth refresh token
    email?: string            // OAuth æä¾›å•†è¿”å›çš„é‚®ç®±
    avatarUrl?: string        // OAuth æä¾›å•†è¿”å›çš„å¤´åƒ
    profile?: Record<string, unknown>  // å…¶ä»– profile ä¿¡æ¯
  }
}
```

#### accounts è¡¨

ç”¨æˆ·è´¦æˆ·è¡¨ï¼ˆç§¯åˆ†ã€ä½™é¢ç­‰ï¼‰ã€‚

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | serial | PRIMARY KEY | è´¦æˆ·ID |
| user_id | integer | NOT NULL, UNIQUE, FK â†’ users.id | æ‰€å±ç”¨æˆ· |
| balance | bigint | NOT NULL, DEFAULT 0 | ç§¯åˆ†ä½™é¢ |
| created_at | timestamptz | NOT NULL | åˆ›å»ºæ—¶é—´ |
| updated_at | timestamptz | NOT NULL | æ›´æ–°æ—¶é—´ |

**æ³¨æ„**:
- `balance` ä½¿ç”¨ `bigint` ç±»å‹ä½†é…ç½®ä¸º `mode: 'number'`
- é€‚ç”¨äºä¸è¶…è¿‡ 2^53 çš„æ•°å€¼ï¼ˆçº¦ 9 åƒä¸‡äº¿ç§¯åˆ†ï¼‰
- å¦‚éœ€æ›´å¤§èŒƒå›´ï¼Œä½¿ç”¨ `mode: 'bigint'`

#### verification_codes è¡¨ï¼ˆé¢„ç•™ï¼‰

é€šç”¨éªŒè¯ç è¡¨ï¼Œæ”¯æŒå¤šæ¸ é“ï¼ˆé‚®ç®±ã€çŸ­ä¿¡ã€è¯­éŸ³ã€WhatsAppï¼‰ã€‚

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | serial | PRIMARY KEY | éªŒè¯ç ID |
| recipient | varchar(255) | NOT NULL | æ¥æ”¶æ–¹ï¼ˆé‚®ç®±/æ‰‹æœºï¼‰ |
| channel | verification_channel | NOT NULL | æŠ•é€’æ¸ é“ |
| code_hash | varchar(255) | NOT NULL | éªŒè¯ç å“ˆå¸Œ |
| purpose | varchar(50) | NOT NULL | ç”¨é€” (login/register) |
| expires_at | timestamptz | NOT NULL | è¿‡æœŸæ—¶é—´ (â‰¤5åˆ†é’Ÿ) |
| used | boolean | DEFAULT false | æ˜¯å¦å·²ä½¿ç”¨ |
| attempts | integer | DEFAULT 0 | å°è¯•æ¬¡æ•° |
| max_attempts | integer | DEFAULT 5 | æœ€å¤§å°è¯•æ¬¡æ•° |
| user_id | integer | NULLABLE, FK â†’ users.id | å…³è”ç”¨æˆ· |
| created_at | timestamptz | NOT NULL | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**:
- INDEX(recipient, channel)
- INDEX(expires_at)

### æšä¸¾ç±»å‹

```sql
-- è®¤è¯æä¾›å•†
CREATE TYPE auth_provider AS ENUM (
  'password',  -- ç”¨æˆ·åå¯†ç 
  'google',    -- Google OAuth
  'github',    -- GitHub OAuth
  'email',     -- é‚®ç®±éªŒè¯ç 
  'sms'        -- çŸ­ä¿¡éªŒè¯ç 
);

-- éªŒè¯ç æ¸ é“
CREATE TYPE verification_channel AS ENUM (
  'email',     -- é‚®ç®±
  'sms',       -- çŸ­ä¿¡
  'voice',     -- è¯­éŸ³
  'whatsapp'   -- WhatsApp
);
```

---

## API è·¯ç”±

### è®¤è¯ç›¸å…³

#### POST /api/auth/check

æ£€æŸ¥ç”¨æˆ·å/é‚®ç®±æ˜¯å¦å·²å­˜åœ¨ï¼ˆç”¨äºç»Ÿä¸€ç™»å½•æ³¨å†Œæµç¨‹ï¼‰ã€‚

**è¯·æ±‚**:
```json
{
  "usernameOrEmail": "john_doe"
}
```

**å“åº”**:
```json
{
  "success": true,
  "exists": true,
  "needsPassword": true,
  "needsRegistration": false
}
```

#### POST /api/auth/authenticate

ç»Ÿä¸€è®¤è¯æ¥å£ï¼Œæ ¹æ®ç”¨æˆ·æ˜¯å¦å­˜åœ¨è‡ªåŠ¨å¤„ç†ç™»å½•æˆ–æ³¨å†Œã€‚

**è¯·æ±‚ï¼ˆç™»å½•ï¼‰**:
```json
{
  "usernameOrEmail": "john_doe",
  "password": "Password123"
}
```

**è¯·æ±‚ï¼ˆæ³¨å†Œï¼‰**:
```json
{
  "usernameOrEmail": "john@example.com",
  "password": "Password123",
  "username": "john_doe",
  "email": "john@example.com"
}
```

**å“åº”**:
```json
{
  "success": true,
  "action": "login",  // or "register"
  "user": {
    "id": 1,
    "username": "john_doe",
    "email": "john@example.com"
  }
}
```

#### GET /api/auth/github

å¯åŠ¨ GitHub OAuth æµç¨‹ã€‚

**è¡Œä¸º**:
1. ç”Ÿæˆ CSRF state
2. è·³è½¬åˆ° GitHub æˆæƒé¡µé¢

#### GET /api/auth/github/callback

GitHub OAuth å›è°ƒå¤„ç†ã€‚

**æŸ¥è¯¢å‚æ•°**:
- `code`: GitHub æˆæƒç 
- `state`: CSRF stateï¼ˆéªŒè¯ï¼‰

**è¡Œä¸º**:
1. éªŒè¯ state
2. ç”¨ code æ¢å– access_token
3. è·å– GitHub ç”¨æˆ·ä¿¡æ¯
4. åˆ›å»ºæˆ–æŸ¥æ‰¾ç”¨æˆ·
5. åˆ›å»ºä¼šè¯
6. è·³è½¬åˆ°é¦–é¡µ

#### POST /api/auth/logout

ç™»å‡ºç”¨æˆ·ã€‚

**å“åº”**:
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

#### GET /api/auth/me

è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦è®¤è¯ï¼‰ã€‚

**å“åº”**:
```json
{
  "success": true,
  "user": {
    "id": 1,
    "username": "john_doe",
    "email": "john@example.com",
    "avatar": "https://avatars.githubusercontent.com/..."
  }
}
```

---

## ç”¨æˆ·ä½“éªŒè®¾è®¡

### ç»Ÿä¸€ç™»å½•æ³¨å†Œå…¥å£

#### è®¾è®¡ç†å¿µ

åŸºäº 2025 å¹´ UX æœ€ä½³å®è·µï¼š
- **ç®€åŒ–æµç¨‹** - ç”¨æˆ·æ— éœ€åˆ¤æ–­æ˜¯"ç™»å½•"è¿˜æ˜¯"æ³¨å†Œ"
- **æ™ºèƒ½è¯†åˆ«** - ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ˜¯å¦å­˜åœ¨
- **æ¸è¿›å¼è¡¨å•** - æ ¹æ®çŠ¶æ€åŠ¨æ€æ˜¾ç¤ºå¿…è¦å­—æ®µ

#### äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç¬¬ä¸€æ­¥ï¼šè¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±           â”‚
â”‚                                     â”‚
â”‚   Username or Email                 â”‚
â”‚   [_________________________]       â”‚
â”‚                                     â”‚
â”‚   [Continue] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â†’ ç”¨æˆ·å­˜åœ¨
              â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   â”‚   ç¬¬äºŒæ­¥ï¼šç™»å½•æ¨¡å¼                   â”‚
              â”‚   â”‚                                     â”‚
              â”‚   â”‚   Signing in as                     â”‚
              â”‚   â”‚   [john_doe]           [Change]     â”‚
              â”‚   â”‚                                     â”‚
              â”‚   â”‚   Password                          â”‚
              â”‚   â”‚   [_________________________]       â”‚
              â”‚   â”‚                                     â”‚
              â”‚   â”‚   [Sign In] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º       â”‚
              â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â””â”€â†’ ç”¨æˆ·ä¸å­˜åœ¨
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   ç¬¬äºŒæ­¥ï¼šæ³¨å†Œæ¨¡å¼                   â”‚
                  â”‚                                     â”‚
                  â”‚   Username                          â”‚
                  â”‚   [john_doe_______________]         â”‚
                  â”‚                                     â”‚
                  â”‚   Email                             â”‚
                  â”‚   [john@example.com_______]         â”‚
                  â”‚                                     â”‚
                  â”‚   Password                          â”‚
                  â”‚   [_________________________]       â”‚
                  â”‚                                     â”‚
                  â”‚   Confirm Password                  â”‚
                  â”‚   [_________________________]       â”‚
                  â”‚                                     â”‚
                  â”‚   [Create Account] â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º       â”‚
                  â”‚   â† Back to start                   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OAuth é›†æˆ

åœ¨åˆå§‹ç•Œé¢æä¾› OAuth é€‰é¡¹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Username or Email                  â”‚
â”‚  [_________________________]        â”‚
â”‚                                     â”‚
â”‚  [Continue] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º     â”‚
â”‚                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Or â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                     â”‚
â”‚  [GitHubå›¾æ ‡] Github                â”‚
â”‚  [Googleå›¾æ ‡] Google                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## éƒ¨ç½²æŒ‡å—

### ç¯å¢ƒå˜é‡é…ç½®

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶é…ç½®ï¼š

```bash
# æ•°æ®åº“
DATABASE_URL=postgresql://user:password@host:5432/dbname

# è®¤è¯å¯†é’¥ (è‡³å°‘ 32 å­—ç¬¦)
AUTH_SECRET=$(openssl rand -base64 32)

# GitHub OAuth (å¯é€‰)
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret

# åˆå§‹ç§¯åˆ† (é»˜è®¤: 0)
INITIAL_CREDITS=500

# ç¯å¢ƒ
NODE_ENV=production
```

### æ•°æ®åº“è¿ç§»

```bash
# 1. ç”Ÿæˆè¿ç§»æ–‡ä»¶
pnpm db:generate

# 2. åº”ç”¨è¿ç§»
pnpm db:push

# æˆ–ä½¿ç”¨ migrate
pnpm db:migrate
```

### éªŒè¯éƒ¨ç½²

1. **æ£€æŸ¥ç¯å¢ƒå˜é‡**:
   ```bash
   node -e "const {env} = require('./lib/env'); console.log('âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®')"
   ```

2. **æµ‹è¯•æ•°æ®åº“è¿æ¥**:
   ```bash
   pnpm db:studio
   ```

3. **æµ‹è¯•ç™»å½•åŠŸèƒ½**:
   - è®¿é—® `/login`
   - å°è¯•æ³¨å†Œæ–°ç”¨æˆ·
   - å°è¯•ç™»å½•
   - æµ‹è¯• GitHub OAuthï¼ˆå¦‚å·²é…ç½®ï¼‰

---

## å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [Next.js 16 Documentation](https://nextjs.org/docs)
- [Drizzle ORM Documentation](https://orm.drizzle.team/)
- [Jose (JWT) Documentation](https://github.com/panva/jose)

### å®‰å…¨æœ€ä½³å®è·µ
- [Next.js Authentication Best Practices (2025)](https://nextjs.org/docs/pages/guides/authentication)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [CVE-2025-29927 - Next.js Middleware Vulnerability](https://medium.com/@franciscomoretti/next-js-authentication-best-practices-6897dad3a170)

### UX è®¾è®¡
- [Login & Signup UX â€“ Complete 2025 Guide](https://www.authgear.com/post/login-signup-ux-guide)
- [Best Sign Up Flows (2025)](https://www.eleken.co/blog-posts/sign-up-flow)

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| 1.0.0 | 2025-12 | åˆå§‹ç‰ˆæœ¬ - å®ç°ç”¨æˆ·åå¯†ç ç™»å½•å’Œ GitHub OAuth |

---

## ç»´æŠ¤è€…

Lumina AI Studio Team

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issueã€‚
