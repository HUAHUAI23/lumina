/**
 * 火山引擎类型定义
 */

/** 可重试错误码（服务端问题，重试可能成功） */
export const RETRYABLE_ERROR_CODES = new Set([
  // 限流相关
  50429, // QPS超限
  50430, // 并发超限

  // 服务端内部错误
  50500, // 内部错误
  50501, // 内部RPC错误

  // 输出审核/服务异常（输出问题，重试可能生成不同内容）
  50516, // 输出视频审核未通过
  50517, // 输出音频审核未通过
  50519, // 输出版权图审核未通过
  50520, // 审核服务异常
  50521, // 版权词服务异常
  50522, // 版权图服务异常
])

/** 不可重试错误码（客户端问题，重试也不会成功） */
export const NON_RETRYABLE_ERROR_CODES = new Set([
  // 参数/输入错误（50200-50215）
  50200, // 参数错误
  50201, // 缺少参数
  50204, // 参数类型错误/参数缺失
  50205, // 图像尺寸超过限制
  50206, // 请求参数中没有获取到图像
  50207, // 图像解码错误
  50209, // 请求参数中没有获取到视频
  50210, // 视频解码错误
  50211, // 视频尺寸超过限制
  50213, // 请求Body过大
  50214, // 输入视频时长过大
  50215, // 输入的图片、视频、参数等不满足要求 ← 你遇到的错误！

  // 输入审核未通过（50411-50413, 50518）
  50411, // 输入图片审核未通过
  50412, // 输入文本审核未通过
  50413, // 输入含敏感词
  50518, // 输入版权图审核未通过

  // 算法相关错误（60xxx）
  60102, // 未检测到人脸
  60208, // 包含敏感信息

  // 权限错误
  50400, // 权限校验失败
  50402, // 访问的接口不存在
])

/** 判断错误码是否可重试 */
export function isRetryableError(code: number): boolean {
  // 明确的不可重试错误
  if (NON_RETRYABLE_ERROR_CODES.has(code)) return false

  // 明确的可重试错误
  if (RETRYABLE_ERROR_CODES.has(code)) return true

  // 其他错误默认不可重试（安全策略）
  // 之前的默认策略（5xx都可重试）太宽松，导致50215被错误地重试
  return false
}